Bootstrap: docker
From: nvidia/cuda:12.2.2-cudnn8-runtime-ubuntu22.04

%labels
  org.opencontainers.image.title Helixer
  org.opencontainers.image.version 0.3.6
  org.opencontainers.image.source https://github.com/gglyptodon/helixer-docker

%environment
  export APP_HOME=/opt/helixer
  export PATH="${APP_HOME}/bin:/root/.cargo/bin:${PATH}"

%post
  set -e
  APP_HOME=/opt/helixer
  export DEBIAN_FRONTEND=noninteractive
  cd /root

  apt-get update -y
  apt-get install -y --no-install-recommends \
    python3-dev python3-pip python3-venv git libhdf5-dev curl \
    libbz2-dev liblzma-dev wget zip nano cuda-compiler-12-2 gcc g++ make
  rm -rf /var/lib/apt/lists/*

  # --- prep for hdf5 for HelixerPost --- #
  cd /tmp
  curl -L https://github.com/h5py/h5py/releases/download/3.10.0/h5py-3.10.0.tar.gz -o h5py-3.10.0.tar.gz
  tar -xzvf h5py-3.10.0.tar.gz
  cd h5py-3.10.0/lzf/
  gcc -O2 -fPIC -shared -Ilzf -I/usr/include/hdf5/serial/ lzf/*.c lzf_filter.c -lhdf5_cpp -L/lib/x86_64-linux-gnu/hdf5/serial -o liblzf_filter.so
  install -d /usr/lib/x86_64-linux-gnu/hdf5/plugins
  mv liblzf_filter.so /usr/lib/x86_64-linux-gnu/hdf5/plugins
  cd /tmp
  rm -rf /tmp/h5py*

  # --- rust install for HelixerPost --- #
  cd /root
  curl https://sh.rustup.rs -sSf > /tmp/rustup.sh
  chmod 755 /tmp/rustup.sh
  HOME=/root /tmp/rustup.sh -y
  rm /tmp/rustup.sh
  export PATH="/root/.cargo/bin:${PATH}"

  # --- Helixer and HelixerPost --- #
  mkdir -p ${APP_HOME}
  cd ${APP_HOME}
  pip install --upgrade pip
  git clone https://github.com/weberlab-hhu/Helixer.git Helixer
  cd Helixer
  git checkout tags/v0.3.6
  pip install --no-cache-dir -r requirements.3.10.txt
  pip install --no-cache-dir .

  cd ${APP_HOME}
  git clone https://github.com/TonyBolger/HelixerPost.git
  cd HelixerPost
  git checkout 4d4799bac4c05e574ae628040c5cb58eb4aa18fe
  mkdir -p ${APP_HOME}/bin
  cd helixer_post_bin
  cargo build --release
  mv ${APP_HOME}/HelixerPost/target/release/helixer_post_bin ${APP_HOME}/bin/
  rm -rf ${APP_HOME}/HelixerPost/target/release/

%runscript
  exec "$@"
